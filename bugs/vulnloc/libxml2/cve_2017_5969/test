#!/bin/bash
set -eu

HERE_DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
PATH_EXPLOIT="${HERE_DIR}/exploit"
BUG_FILE="${HERE_DIR}/bug.json"
SUBJECT_PATH="$(jq -r ".binary" "${BUG_FILE}")"
PATH_BIN="${1:-${HERE_DIR}/source/${SUBJECT_PATH}}"

${TEST_EXECUTION_PREFIX:-} "${PATH_BIN}" --recover "${PATH_EXPLOIT}"
x=$?

SUBJECT_PATH="$(jq -r ".fbinary" "${BUG_FILE}")"
PATH_BIN="${1:-${HERE_DIR}/source/${SUBJECT_PATH}}"
if [[ -e $PATH_BIN ]]; then 
${TEST_EXECUTION_PREFIX:-} "${PATH_BIN}" --recover "${PATH_EXPLOIT}"
x=$?
fi

exit $x