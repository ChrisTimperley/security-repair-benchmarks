#!/bin/bash

function EXIT_CHECK {
local y=$1
local x=$y

FAILURE_EXIT_CODE=134
SIGTERM_EXIT_CODE=143

if [[ $y == $FAILURE_EXIT_CODE ]]; then 
	x=1; 
elif [[ $y == $SIGTERM_EXIT_CODE ]] ; then
	x=0; 
else
	x=$y; 
fi; 
echo $x

}

HERE_DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
PATH_EXPLOIT="${HERE_DIR}/exploit-4"
PATH_BIN="${1:-${HERE_DIR}/source/dbuild/tools/tiffcrop}"
TEST_EXECUTION_PREFIX="timeout --preserve-status -k 60 60"

${TEST_EXECUTION_PREFIX:-} "${PATH_BIN}" -i "${PATH_EXPLOIT}" foo
x=$?

if [[ -e "${HERE_DIR}/BUG.cfg" ]]; then 
PATH_BIN="${1:-${HERE_DIR}/source/fbuild/tools/tiffcrop}"
if [[ -e $PATH_BIN ]]; then 
${TEST_EXECUTION_PREFIX:-} "${PATH_BIN}" -i "${PATH_EXPLOIT}" foo
x=$?
fi
fi

exit $(EXIT_CHECK $x)
