#!/bin/bash
set -eu

HERE_DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
SOURCE_DIR="${HERE_DIR}/source"

CONFIG_PATH="./configure"
CONFIG_OPTIONS="--disable-shared --disable-gdb --disable-libdecnumber --disable-readline --disable-sim LIBS='-ldl -lutil'"

pushd "${SOURCE_DIR}"

export CFLAGS="-DFORTIFY_SOURCE=2 -ggdb -Wno-error ${CFLAGS:-}"
export CXXFLAGS="$CFLAGS  ${CXXFLAGS:-}"


if [[ "${REPAIR_TOOL}" == "extractfix" ]]; then
  COMPILE_TYPE="$1"
  CONFIG_PATH="../configure"

  if ! grep -qF "size_t LOWFAT_GLOBAL_MS__readelf_get_data_423;" ./binutils/readelf.c; then
    echo "PREPROCESS"
    sed -i '423s/malloc ((size_t) amt + 1)/malloc (({LOWFAT_GLOBAL_MS__readelf_get_data_423 = (size_t) amt + 1; LOWFAT_GLOBAL_MS__readelf_get_data_423;}))/' ./binutils/readelf.c
    sed -i '360isize_t LOWFAT_GLOBAL_MS__readelf_get_data_423;' ./binutils/readelf.c
  fi

  if ! grep -qF "extern size_t LOWFAT_GLOBAL_MS__readelf_get_data_423" ./binutils/dwarf.c; then
    echo "PREPROCESS"
    sed -i '126iextern size_t LOWFAT_GLOBAL_MS__readelf_get_data_423;' ./binutils/dwarf.c
  fi

  rm -rf klee
  mkdir klee
  pushd klee

  # TODO this seems to always be the same?
  export CFLAGS="-g -D__NO_STRING_INLINES  -D_FORTIFY_SOURCE=0 -U__OPTIMIZE__ -lkleeRuntest -lkleeBasic -Wno-everything ${CFLAGS:-}"

  # TODO these seem to always be the same? [sometimes contains project-specific lib] could be autogenerated?
  if [[ "${COMPILE_TYPE}" == "to_bc" ]]; then
    export LLVM_COMPILER=clang
    export CC=wllvm
  elif [[ "${COMPILE_TYPE}" == "lowfat" ]]; then
    export CC="${LOWFAT_CLANG}"
    export CFLAGS="${CFLAGS} -fsanitize=lowfat -mllvm -lowfat-debug -mllvm -lowfat-no-check-memset -mllvm -lowfat-no-check-memcpy -mllvm -lowfat-no-check-escapes -mllvm -lowfat-no-check-fields -mllvm -lowfat-symbolize -lstlimpl"
  fi
fi

"${CONFIG_PATH}" ${CONFIG_OPTIONS}
